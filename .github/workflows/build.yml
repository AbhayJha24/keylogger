name: Linting and Building
description: This workflow runs on every push to the repository and performs linting and building tasks.
on: [push]
jobs:
    Linting:
        name: Linting Job
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.10'

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Run mypy
              run: |
                mypy klogger.py --config-file .mypy.ini --show-error-codes --ignore-missing-imports
                if [ $? -ne 0 ]; then
                  echo "Mypy found errors."
                  exit 1
                fi
            
            - name: Run pylint
              run: |
                pylint klogger.py --output-format=json > pylint-report.json
                cat pylint-report.json
                # Fail if there are any errors (exit code >= 32)
                ERRORS=$(jq '[.[] | select(.type=="error")] | length' pylint-report.json)
                if [ "$ERRORS" -gt 0 ]; then
                echo "Pylint found $ERRORS errors."
                exit 1
                fi

    Building:
        name: Building Job
        runs-on: ubuntu-latest
        needs: Linting
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.10'

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Build executable
              run: |
                pyinstaller --onefile klogger.py
                if [ $? -ne 0 ]; then
                  echo "Build failed."
                  exit 1
                fi

            # Added for testing purposes
            - name: Check current directory
              run: |
                echo "Current directory:"
                pwd
                echo "Files in current directory:"
                ls -la

            - name: Archive build artifacts
              uses: actions/upload-artifact@v4
              with:
                name: klogger
                path: dist/klogger.exe

            - name: Create GitHub Release Linux
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                files: dist/klogger.exe
   